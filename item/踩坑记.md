# 云对讲

* 更新功能之前，考虑下是否需要先造点旧数据，比如人脸识别升级

* `BufferedImage image = ImageIO.read(inputStream);`返回为null

  * 因为该`inputStream`不是文件（图片）转换成的`inputStream`，不是图片流而是数据流，所以不能转成图片

* 将将`MultipartFile`转为`File`

  ```java
  private File getFileByMultipartFile(MultipartFile multipartFile) {
    if(multipartFile != null) {
      CommonsMultipartFile cf= (CommonsMultipartFile)multipartFile;
      DiskFileItem fi = (DiskFileItem)cf.getFileItem();
      if(fi != null) {
        return fi.getStoreLocation();
      }
    }
    return null;
  }
  ```

* 将`URL`转成`File`

  ```java
  URL urlInfo = new URL(imgUrl);
  File file = new File(urlInfo.toURI().getPath());
  ----
  FileUtils.copyURLToFile(imgUrl, new File("/Users/dingyuanjie/Downloads/test.png"));
  
  //待测试
  BufferedImage image = ImageIO.read(new File(imgUrl));
              ByteArrayOutputStream bs = new ByteArrayOutputStream();
              ImageOutputStream imOut = ImageIO.createImageOutputStream(bs);
              ImageIO.write(image, "png", imOut);
              InputStream inputStream = new ByteArrayInputStream(bs.toByteArray());
  ```

* 本地代码远程Debug Linux上的Tomcat

  * `tomcat`的`bin`目录下`catalina.sh`文件中

    ```java
    //CATALINA_OPS属性中增加-Xdebug -Xrunjdwp:transport=dt_socket,address=6004,server=y,suspend=n"
    //设置JPDA_ADDRESS="6004"
    
    CATALINA_OPS="$CATALINA_OPTS -Dfile.encoding=UTF8 -Djava.net.preferIPv4Stack=true  -Dorg.apache.catalina.loader.WebappClassLoader.ENABLE_CLEAR_R
    EFERENCES=false -Duser.timezone=GMT+8  -Xms256m -Xmx1024m -XX:PermSize=128m -XX:MaxPermSize=256m  -Xdebug -Xrunjdwp:transport=dt_socket,address=
    6004,server=y,suspend=n"
    ```

  * 外部能`telnet`通6004端口：`telnet ip 6004`
  * 服务器启动方式
    * `cd bin/`
    * `./catalina.sh jpda start`

* maven项目添加外部依赖

  ```xml
  <dependency>
    <groupId>com.arcsoft</groupId>
    <artifactId>face</artifactId>
    <version>2.1</version>
    <scope>system</scope>
    <systemPath>${project.basedir}/../efastFR/libs/arcsoft-sdk-face-2.1.0.0.jar</systemPath>
  </dependency>
  ```

* maven打包失败，提示`/efastFR/lib不存在`
  
  * 在`efastFR`下新建`lib`目录
  
* `tomcat7`换成`tomcat8`时，`conf/context.xml`中`jdbc`的配置属性名称需要更改

* java.io.IOException: Broken pipe

  ```java
  URL faceUrl = new URL(imgUrl);
  URLConnection urlConnection = faceUrl.openConnection();
  urlConnection.setConnectTimeout(5000);
  urlConnection.setReadTimeout(5000);
  urlConnection.getInputStream();
  ```
  
* ==人脸识别工具类中方法调用==

  * 问题：工具类中引擎对象为null，导致出现空指针异常
  * 原因：引擎对象没初始化，使用之前必须先初始化，是根据web容器启动(监听)而初始化，所以需要将初始化类配置到web.xml的监听器中
  * 只有app和web模块配置了引擎初始化，所以只能在这两个模块中使用人脸识别工具，在其他模块，如service模块中就不能使用，因为引擎没初始化
  
* 写业务功能之前，先把逻辑理顺，先干什么，再干什么，最后干什么

* 查看tomcat日志

  * `tail -2000 all.log`

* 日志`slf4j`

  * 本地调试报错时，如果要看到SQL语句及参数，将Log（Log4j）日志级别改为==Debug模式==
  * `private static final Logger logger = LoggerFactory.getLogger(Abc.class);`
  * 使用占位符`logger.debug("Processing trade with id: {} and symbol : {} ", id, symbol);`
  * 避免重复打印日志，浪费磁盘空间，务必在 log4j.xml中设置 additivity=false，`<logger name="com.taobao.dubbo.config" additivity="false">`

* 异常处理

  * 异常信息应该包括两类信息：案发现场信息和异常堆栈信息。如果不处理，那么通过关键字==throws== 往上抛出`logger.error(各类参数或者对象toString() + "_" +e.getMessage(), e);`

