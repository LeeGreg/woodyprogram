<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
        "http://mybatis.apache.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.faw_vk.qak.mgmt.dao.report.QualityIssueReportDao">

    <sql id="whereCondition">
        where 1 =1
        <if test="requireType != null and requireType !=''">
            and issue.require_type = #{requireType}
        </if>
        <if test="formType != null and formType !=''">
            and issue.form_type = #{formType}
        </if>
        <if test="reportIssueStatus != null and reportIssueStatus.size() > 0">
            and issue.status in
            <foreach collection="reportIssueStatus" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </sql>

    <sql id="reportWhere">
        where 1 = 1
        <if test="createWeekOfYear != null">
            and report.CREATE_WEEK_OF_YEAR = #{createWeekOfYear}
        </if>
        <if test="reportType != null">
            and report.REPORT_TYPE = #{reportType}
        </if>
        <if test="requireType != null and requireType != ''">
            and report.require_type=#{requireType}
        </if>
        <if test="createYearMonth != null and createYearMonth !='' and startTime == null">
            and report.create_year_month = #{createYearMonth}
        </if>
        <if test="createYearMonth != null and createYearMonth != '' and startTime != null and startTime != ''">
            and report.create_year_month between #{startTime} and #{createYearMonth}
        </if>
        <if test="deps !=null and deps.size()>0">
            and report.DEPARTMENT in (
            <foreach collection="deps" item="item" separator=",">
                #{item}
            </foreach>
            )
        </if>

    </sql>

    <sql id="reports">
        report.id as id,
        report.require_type as requireType,
        report.create_date as createDate,
        report.create_year_month as createYearMonth,
        report.create_week_of_year as createWeekOfYear,
        report.department as department,
        report.pro_group as proGroup,
        report.withdraw_count as withdrawCount,
        report.edit_count as editCount,
        report.expression_count as expressionCount,
        report.require_count as requireCount,
        report.report_type as reportType
    </sql>

    <delete id="deleteDataSchedu">
        delete from t_quality_report where 1 = 1
        <if test="requireType != null and requireType !='' ">
            and require_type = #{requireType}
        </if>
        <if test="createYearMonth != null and createYearMonth != ''">
            and create_year_month = #{createYearMonth}
        </if>
        <if test="createWeekOfYear != null">
            and create_week_of_year = #{createWeekOfYear}
        </if>
        <if test="reportType != null">
            and report_type = #{reportType}
        </if>
    </delete>

    <select id="queryQualityByTypeAndStatus" resultType="com.faw_vk.qak.mgmt.entity.QualityIssue">
        select
        issue.major_group as majorGroup,
        issue.require_type as requireType,
        count(major_group) as count
        from t_quality_issue issue
        left join t_basic_tree tree on tree.name = issue.major_group and tree.node_type='group'
        <include refid="whereCondition"/>
        group by major_group
    </select>

    <select id="queryProcessQualityByTypeAndStatus" resultType="com.faw_vk.qak.mgmt.entity.QualityIssue">
        select
        issue.require_type as requireType,
        issue.pres_user_local as presUserLocal,
        org.parent_id as parentID,
        count(pres_user_local) as count
        from t_quality_issue issue
        left join portal_company_org org on org.org_name = issue.pres_user_local
        <include refid="whereCondition"/>
        group by issue.pres_user_local
    </select>

    <select id="queryBaseWeekReport" resultType="com.faw_vk.qak.mgmt.entity.QualityReport">
        select
        <include refid="reports"/>
        from t_quality_report report
        <include refid="reportWhere"/>
    </select>

    <select id="queryProcessReportTime" resultType="com.faw_vk.qak.mgmt.entity.QualityReport">
        select
        CREATE_YEAR_MONTH as createYearMonth,
        sum(WITHDRAW_COUNT) as withdrawCount,
        sum(EDIT_COUNT) as editCount,
        sum(EXPRESSION_COUNT) as expressionCount,
        sum(REQUIRE_COUNT) as requireCount
        from t_quality_report report
        <include refid="reportWhere"/>
        group by CREATE_YEAR_MONTH
        order by CREATE_YEAR_MONTH asc
    </select>

    <select id="queryAllDepByCompanyCode" resultType="java.lang.String">
        select org_name
        from portal_company_org
        where company_code = #{companyCode}
        and parent_id in('0', '1')
        <if test="inDeps !=null and inDeps.size()>0">
            and org_name in (
            <foreach collection="inDeps" item="item" separator=",">
                #{item}
            </foreach>
            )
        </if>
        order by portal_company_org_id asc
    </select>

    <insert id="insertDataSchedu">
        <if test="list != null and list.size() > 0">
            insert into t_quality_report
            (require_type, create_date, create_year_month, create_week_of_year,
            department, pro_group, withdraw_count,edit_count,
            expression_count, require_count, report_type)
            values
            <foreach collection="list" index="index" item="item" separator=",">
                (#{item.requireType}, #{item.createDate}, #{item.createYearMonth},
                #{item.createWeekOfYear}, #{item.department}, #{item.proGroup},
                #{item.withdrawCount}, #{item.editCount}, #{item.expressionCount},
                #{item.requireCount}, #{item.reportType})
            </foreach>
        </if>
    </insert>
</mapper>
