# 各功能代码看5遍再写总结

# 旧登录

## App

* 调用sso模块的token接口，校验用户名和密码，UUID生成的token为key，用户信息为value，存入redis，返回token

  * sso模块过滤器SessionFilter

    * 获取sid：判断request中是否有约定名称的cookie，有-cookie的value为sid，没有-UUID生成sid，将约定名称作为name，sid为value来构造cookie并存入response中

    * 调用下一个filter：

      ```java
      1. filterChain.doFilter(new HttpServletRequestWrapper(sid, request, response), response);
      2. public HttpServletRequestWrapper(String sid, HttpServletRequest request,
      	            HttpServletResponse response) {
        super(request);
        this.request = request;
        this.response = response;
        this.sid = sid;         
        if (this.session == null) {
          this.session = new HttpSessionWrapper(sid, super.getSession(false),
                                                request, response);
        }
      }
      3. HttpSessionWrapper implements HttpSession
      4. public HttpSessionWrapper(String sid, HttpSession session,
      	            HttpServletRequest request, HttpServletResponse response) {
        this(sid, session);
        this.request = request;
        this.response = response;
      }
      ```

* 调用eldf-portal-web模块的appuserinfo接口，该模块使用同样的过滤器SessionFilter、也使用登录验证拦截器拦截访问特定资源并验证

  * appuserinfo接口：没被拦截，通过token从redis中取出用户信息

    ```java
    // request为过滤器中重写的HttpServletRequestWrapper
    1. HttpSession session = request.getSession(true);
    	 session为new HttpSessionWrapper(UUID.randomUUID().toString(),
    	                        super.getSession(create), this.request, this.response);
    2. session.setAttribute(CommonConstant.CURRENT_LOGIN_USER_NAME_KEY, username);
    	 为重写后的setAttribute方法，根据SESSIONID+sid为key到redis中查找value为Map的session，没有则新建Map为sesssion，存入name、value参数，然后再存入redis
    3. 删除redis中的token
    3. 将SESSIONID+sid返回
    ```

  * 拦截器

    ```java
    1. 从过滤器传过来的request中取出session
    2. 从token中取出
    ```

    



## Web

* 登录
  * `https://tkzhushou.mylianzhi.com/eldf-sso/dologin`
  * `https://tkzhushou.mylianzhi.com/eldf-portal-web/auth/callback_result?code=197E9FD0CCFDD4B499BB864EC9EBC0384EFF2`
  * `https://tkzhushou.mylianzhi.com/eldf-portal-web/frame_center`
  * `https://tkzhushou.mylianzhi.com/eldf-portal-web/common/i18n/languages.json?_=1558578959186`
  * `https://tkzhushou.mylianzhi.com/eldf-portal-web/common/i18n/common.properties?_=1558578959187`
  * `https://tkzhushou.mylianzhi.com/eldf-portal-web/common/i18n/common_zh_CN.properties?_=1558578959188`
  * `https://tkzhushou.mylianzhi.com/community.manage-web/communityManage/community/search`
  * `https://tkzhushou.mylianzhi.com/eldf-portal-web/frame_center/portal/menus?i18n=zh_CN&time=1558578960628&_=1558578959189`
  * `https://tkzhushou.mylianzhi.com/community.manage-web/res/i18n/languages.json?_=1558578959191`
  * `https://tkzhushou.mylianzhi.com/community.manage-web/res/i18n/community.properties?_=1558578959192`
  * `https://tkzhushou.mylianzhi.com/eldf-portal-web/frame_center/common/parameterselect?paramKey=COMMUNITY_STATUS&moduleName=Community&_=1558578959203`
* 注销
  * `https://tkzhushou.mylianzhi.com/eldf-portal-web/auth/logout/C0006`
  * `https://tkzhushou.mylianzhi.com/eldf-sso/oauth/authorize_i?client_id=frank-eldf-portal&redirect_uri=https%3A%2F%2Ftkzhushou.mylianzhi.com%3A443%2Feldf-portal-web%2Fauth%2Fcallback_result&response_type=code&scope=read`
  * `https://tkzhushou.mylianzhi.com/eldf-sso/logout`
  * `https://tkzhushou.mylianzhi.com/eldf-sso/login.htm`

# 新登录

# Hessian

# 长连接

# 日志



